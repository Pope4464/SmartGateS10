{% extends "layout.html" %}

{% block title %}Streams{% endblock %}

{% block content %}
<!-- Main Content Wrapper -->
<div class="main-content">
    <section class="background">
        <video autoplay muted loop id="backgroundVideo">
            <source src="../static/NewFolder/bakground_video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="overlay"></div>
    </section>

    <div class="about-container">
        <h1>Camera Streams</h1>
    </div>

    <!-- Camera Streams - Dynamically Rendered -->
    <div class="camera-feeds" id="streams-container">
        <!-- Streams will be dynamically rendered here -->
    </div>
</div>

<script>
// --------------S10 DYNAMIC STREAMS--------------
const streamImages = [
    '/static/images/amur-leopard.jpg',
    '/static/images/bongo-antelope.jpg', 
    '/static/images/elephant.jpeg',
    '/static/images/forest-background.jpg',
    '/static/images/oranguton.jpg',
    '/static/images/panda.jpg'
];

function renderStreams(gatesData) {
    const container = document.getElementById('streams-container');
    container.innerHTML = '';
    
    gatesData.forEach((gate, index) => {
        const streamDiv = document.createElement('div');
        streamDiv.className = 'camera-feed';
        streamDiv.setAttribute('data-gate-no', gate.id);
        
        // Determine online/offline status
        const onlineStatus = gate.online_status || 'offline';
        
        streamDiv.innerHTML = `
            <div class="stream-container" id="stream${gate.id}">
                <img src="${gate.image_url || streamImages[index] || '/static/images/placeholder.jpg'}" alt="Camera Stream" class="stream-placeholder">
            </div>
            <div class="feed-info">
                <span>GATE NO: ${gate.id}</span><br>
                <span class="online-status ${onlineStatus}">${onlineStatus.toUpperCase()}</span><br>
                <span class="status offline">Status: Offline</span>
            </div>
            <div class="feed-buttons">
                <button class="btn start-stream" onclick="toggleStream(${gate.id})" ${onlineStatus === 'offline' ? 'disabled' : ''}>START STREAM</button>
            </div>
        `;
        container.appendChild(streamDiv);
    });
}

function loadStreams() {
    fetch('/gates/api')
        .then(response => response.json())
        .then(data => {
            renderStreams(data.gates || []);
        })
        .catch(error => {
            console.error('Error loading streams:', error);
            // Fallback to empty streams if API fails
            renderStreams([]);
        });
}

// --------------S10 CAMERA STREAM--------------
function toggleStream(gateNo) {
    const button = document.querySelector(`[data-gate-no="${gateNo}"] .btn`);
    const status = document.querySelector(`[data-gate-no="${gateNo}"] .status`);
    const container = document.getElementById(`stream${gateNo}`);
    
    if (button.textContent === 'START STREAM') {
        // Start stream
        button.textContent = 'STOP STREAM';
        button.className = 'btn stop-stream';
        status.textContent = 'Status: Online';
        status.className = 'status online';
        
        // Replace placeholder with actual stream (via reverse tunnel)
        container.innerHTML = `<img src="http://54.252.172.171:8080/stream" alt="Live Stream" class="live-stream">`;
        
        // S10 CODE REVERSE TUNNEL - Stream accessible via reverse tunnel
    } else {
        // Stop stream
        button.textContent = 'START STREAM';
        button.className = 'btn start-stream';
        status.textContent = 'Status: Offline';
        status.className = 'status offline';
        
        // Replace stream with placeholder
        const placeholders = ['/static/images/amur-leopard.jpg', '/static/images/bongo-antelope.jpg', 
                            '/static/images/elephant.jpeg', '/static/images/forest-background.jpg'];
        const placeholderIndex = (gateNo - 1) % placeholders.length;
        container.innerHTML = `<img src="${placeholders[placeholderIndex]}" alt="Camera Stream" class="stream-placeholder">`;
        
        // S10 CODE REVERSE TUNNEL - Stream stopped, no additional command needed
    }
    // --------------S10 CAMERA STREAM END--------------
}

// Load streams on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStreams();
});

// Update streams every 5 seconds
setInterval(loadStreams, 5000);
// --------------S10 DYNAMIC STREAMS END--------------
</script>

<style>
    .background {
        position: relative;
        text-align: center;
        color: white;
        padding: 10px 10px;
        height: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1;
    }
    
    .camera-feeds {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, auto);
        gap: 15px;
        padding: 20px;
        position: relative;
        z-index: 10;
        margin-top: 10px;
        margin-bottom: 20px;
    }

    .camera-feed {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        text-align: center;
        padding: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stream-container {
        width: 100%;
        height: 200px;
        overflow: hidden;
        border-bottom: 2px solid #ddd;
    }

    .stream-placeholder, .live-stream {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .feed-info {
        margin: 10px 0;
        font-size: 16px;
        font-weight: bold;
    }

    .status.online {
        color: green;
    }

    .status.offline {
        color: red;
    }
    
    .online-status.online {
        color: #28a745;
        font-weight: bold;
    }
    
    .online-status.offline {
        color: #dc3545;
        font-weight: bold;
    }
    
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .feed-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn.start-stream {
        background-color: green;
        color: white;
    }

    .btn.stop-stream {
        background-color: red;
        color: white;
    }
</style>
{% endblock %}
